<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Merge Sort Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Merge Sort Detailed Mode Test</h1>
    <div id="test-results"></div>
    
    <script src="script.js"></script>
    <script>
        // Override console methods to capture output
        const originalLog = console.log;
        const originalError = console.error;
        let testOutput = [];
        
        console.log = (...args) => {
            testOutput.push('LOG: ' + args.join(' '));
            originalLog(...args);
        };
        
        console.error = (...args) => {
            testOutput.push('ERROR: ' + args.join(' '));
            originalError(...args);
        };
        
        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            
            // Test 1: Check if merge sort detailed mode doesn't lose elements
            try {
                // Set up the state for merge sort detailed mode
                state.algorithm = 'merge';
                state.isDetailedMode = true;
                state.numbers = [83, 58, 27, 21, 53, 52, 96, 18];
                state.arrayLength = 8;
                
                // Calculate steps
                calculateMergeSortSteps();
                
                // Check each step for missing elements
                let allStepsValid = true;
                let problemSteps = [];
                
                for (let i = 0; i < state.steps.length; i++) {
                    const step = state.steps[i];
                    const elementCount = {};
                    
                    // Count elements in this step
                    for (let j = 0; j < step.array.length; j++) {
                        const element = step.array[j];
                        elementCount[element] = (elementCount[element] || 0) + 1;
                    }
                    
                    // Check if any original element is missing or duplicated
                    for (const originalElement of [83, 58, 27, 21, 53, 52, 96, 18]) {
                        if (elementCount[originalElement] !== 1) {
                            allStepsValid = false;
                            problemSteps.push({
                                step: i,
                                element: originalElement,
                                count: elementCount[originalElement] || 0,
                                description: step.description
                            });
                        }
                    }
                }
                
                if (allStepsValid) {
                    resultsDiv.innerHTML += '<div class="test-result pass">✅ Test 1 PASSED: No elements lost or duplicated in any step</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="test-result fail">❌ Test 1 FAILED: Element issues found</div>';
                    resultsDiv.innerHTML += '<pre>' + JSON.stringify(problemSteps, null, 2) + '</pre>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result fail">❌ Test 1 ERROR: ' + error.message + '</div>';
            }
            
            // Test 2: Check if the final step is correctly sorted
            try {
                const finalStep = state.steps[state.steps.length - 1];
                const finalArray = [...finalStep.array];
                const expectedSorted = [18, 21, 27, 52, 53, 58, 83, 96];
                
                const isCorrectlySorted = JSON.stringify(finalArray) === JSON.stringify(expectedSorted);
                
                if (isCorrectlySorted) {
                    resultsDiv.innerHTML += '<div class="test-result pass">✅ Test 2 PASSED: Final array is correctly sorted</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="test-result fail">❌ Test 2 FAILED: Final array not correctly sorted</div>';
                    resultsDiv.innerHTML += '<pre>Expected: ' + JSON.stringify(expectedSorted) + '\nActual: ' + JSON.stringify(finalArray) + '</pre>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += '<div class="test-result fail">❌ Test 2 ERROR: ' + error.message + '</div>';
            }
            
            // Show any console output
            if (testOutput.length > 0) {
                resultsDiv.innerHTML += '<h3>Console Output:</h3>';
                resultsDiv.innerHTML += '<pre>' + testOutput.join('\n') + '</pre>';
            }
        }
        
        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>